# qi-openiked

This ansible role is used to setup iked on OpenBSD hosts intended to allow VPN connections.

[TOC] 

# Usage
Include the role in your Ansible `roles_path` either by git subtree (preferred) or ansible-galaxy (not recommended) and then add it to the desired playbook.

## Variables Used
| Name | Description |
| ---  | ---:	     |
| qi_openbsd_iked_host_pub_key | used in tasks/main.yml, is a multiline variable containing the text of the host's public key |
| qi_openbsd_iked_host_cert | used in tasks/main.yml, is a multiline variable containing the text of the host's certificate |
| qi_openbsd_iked_ca_cert | used in tasks/main.yml, is a multiline variable containing the text of the CA certificate |
| qi_openbsd_iked_host_key | used in tasks/main.yml, is a multiline variable generated by the process outlined in [Host Private Key](#markdown-header-host-private-key) |
| qi_openbsd_iked_hostname_domain | used in tasks/main.yml, is the domain of the VPN host and determines part of the filename for the host certificate |     
| | e.g. 'davidson.quoininc.com' |
| qi_openbsd_iked_client_names | used in tasks/main.yml, is a list variable containing the client names whose certificates are present in the `vpn/` directory |
| qi_openbsd_iked_wan_address | used in iked.conf.j2 template, is the IP address of the interface reachable from the WAN |
| qi_openbsd_iked_srcid | used in iked.conf.j2 template, is the CN given to the host in its certificate  |
| qi_openbsd_iked_subnet_assign_from | used in iked.conf.j2 template, is the subnet from which clients will receive IP addresses |   
| | e.g. '192.168.10.0/24' |
| qi_openbsd_iked_filter_tag | used in iked.conf.j2 template, is the tag applied to VPN connection in the logs |


# Host Public Key, Host Certificate, and CA Certificate

The contents of these are placed in multiline variables.  For example:

            qi_openbsd_iked_host_pub_key: |
              -----BEGIN PUBLIC KEY----- 
              <contents of public key> 
              -----END PUBLIC KEY-----


# Host Private Key

The host's private key should be encrypted for storage as a variable.  This is accomplished by the `ansible-vault encrypt_string` command.  For example a certificate named `host.key.pem` could be encrypted by the command `cat host.key.pem | ansible-vault encrypt_string`.  This will ask for a vault password and then output the encrypted contents of the key to stdout.  The user may be prompted for the vault password when running the playbook using the variable by a command such as `ansible-playbook <playbook_name>.yml -i path/to/inventory.yml --vault-id @prompt`.  

## Encrypting Contents
The encrypted contents can then be copy/pasted into the desired variables file.  For example:   

            qi_openbsd_iked_host_key: !vault |    
                      $ANSIBLE_VAULT;1.1;AES256     
                      35363262656539316138663063616130383439353665376434616162393361333439336561666666
                      3764643335356133376562303137336236326135303436650a633461333939386637616633643030
                      38363531386535366235396635663530393934353662346361366264313130333034386531303837    
                      ...    
                      ...   


# Client Certificates 
These should be placed in a `vpn/` subdirectory of the project directory, e.g. `.../src/main/ansible/vpn` for projects following the [Template](https://bitbucket.org/quoin/template/src/master/) paradigm.    
Place a subdirectory within the `vpn/` directory for the certificate of each user of the VPN with user's email as the subdirectory name.    
Finally, the certificate for the user should be named `vpn.crt` and placed in the users's subdirectory.    
For example:    

            tree vpn/   
            ├── user1@domain.com    
            │   └── vpn.crt    
            ├── user2@domain.com    
            │   └── vpn.crt    
            └── user3@domain.com    
                └── vpn.crt    
            
The variable used for this example would have the form:   

            qi_openbsd_iked_client_names:
            - 'user1@domain.com'
            - 'user2@domain.com'
            - 'user3@domain.com'
            
