{"version":3,"file":"index.modern.mjs","sources":["../src/memoize.ts","../src/memoizeWithArgs.ts"],"sourcesContent":["import {\n  createProxy,\n  isChanged,\n  getUntracked,\n  trackMemo,\n} from 'proxy-compare';\n\n// constants from proxy-compare\nconst HAS_KEY_PROPERTY = 'h';\nconst ALL_OWN_KEYS_PROPERTY = 'w';\nconst HAS_OWN_KEY_PROPERTY = 'o';\nconst KEYS_PROPERTY = 'k';\n\ntype HasKeySet = Set<string | symbol>\ntype HasOwnKeySet = Set<string | symbol>\ntype KeysSet = Set<string | symbol>\ntype Used = {\n  [HAS_KEY_PROPERTY]?: HasKeySet;\n  [ALL_OWN_KEYS_PROPERTY]?: true;\n  [HAS_OWN_KEY_PROPERTY]?: HasOwnKeySet;\n  [KEYS_PROPERTY]?: KeysSet;\n};\ntype Affected = WeakMap<object, Used>;\n\nconst isObject = (x: unknown): x is object => typeof x === 'object' && x !== null;\n\nconst untrack = <T>(x: T, seen: Set<T>): T => {\n  if (!isObject(x)) return x;\n  const untrackedObj = getUntracked(x);\n  if (untrackedObj !== null) {\n    trackMemo(x);\n    return untrackedObj;\n  }\n  if (!seen.has(x)) {\n    seen.add(x);\n    Object.entries(x).forEach(([k, v]) => {\n      const vv = untrack(v, seen);\n      if (!Object.is(vv, v)) x[k as keyof T] = vv;\n    });\n  }\n  return x;\n};\n\nconst touchAffected = (dst: unknown, src: unknown, affected: Affected) => {\n  if (!isObject(dst) || !isObject(src)) return;\n  const used = affected.get(getUntracked(src) || src);\n  if (!used) return;\n  used[HAS_KEY_PROPERTY]?.forEach((key) => {\n    Reflect.has(dst, key);\n  });\n  if (used[ALL_OWN_KEYS_PROPERTY] === true) {\n    Reflect.ownKeys(dst);\n  }\n  used[HAS_OWN_KEY_PROPERTY]?.forEach((key) => {\n    Reflect.getOwnPropertyDescriptor(dst, key);\n  });\n  used[KEYS_PROPERTY]?.forEach((key) => {\n    touchAffected(\n      dst[key as keyof typeof dst],\n      src[key as keyof typeof src],\n      affected,\n    );\n  });\n};\n\n// properties\nconst OBJ_PROPERTY = 'o';\nconst RESULT_PROPERTY = 'r';\nconst AFFECTED_PROPERTY = 'a';\n\n/**\n * Create a memoized function\n *\n * @example\n * import { memoize } from 'proxy-memoize';\n *\n * const fn = memoize(obj => ({ sum: obj.a + obj.b, diff: obj.a - obj.b }));\n *\n * @param options\n * @param options.size - (default: 1)\n * @param options.noWeakMap - disable tier-1 cache (default: false)\n */\nexport function memoize<Obj extends object, Result>(\n  fn: (obj: Obj) => Result,\n  options?: { size?: number; noWeakMap?: boolean },\n): (obj: Obj) => Result {\n  let memoListHead = 0;\n  const size = options?.size ?? 1;\n  type Entry = {\n    [OBJ_PROPERTY]: Obj;\n    [RESULT_PROPERTY]: Result;\n    [AFFECTED_PROPERTY]: Affected;\n  }\n  const memoList: Entry[] = [];\n  const resultCache = options?.noWeakMap ? null : new WeakMap<Obj, Entry>();\n  const memoizedFn = (obj: Obj) => {\n    const cache = resultCache?.get(obj);\n    if (cache) {\n      return cache[RESULT_PROPERTY];\n    }\n    for (let i = 0; i < size; i += 1) {\n      const memo = memoList[(memoListHead + i) % size];\n      if (!memo) break;\n      if (!isChanged(memo[OBJ_PROPERTY], obj, memo[AFFECTED_PROPERTY], new WeakMap())) {\n        touchAffected(obj, memo[OBJ_PROPERTY], memo[AFFECTED_PROPERTY]);\n        resultCache?.set(obj, memo);\n        return memo[RESULT_PROPERTY];\n      }\n    }\n    const affected: Affected = new WeakMap();\n    const proxy = createProxy(obj, affected);\n    const result = untrack(fn(proxy), new Set());\n    touchAffected(obj, obj, affected);\n    const entry: Entry = {\n      [OBJ_PROPERTY]: obj,\n      [RESULT_PROPERTY]: result,\n      [AFFECTED_PROPERTY]: affected,\n    };\n    memoListHead = (memoListHead - 1 + size) % size;\n    memoList[memoListHead] = entry;\n    resultCache?.set(obj, entry);\n    return result;\n  };\n  return memoizedFn;\n}\n","import { memoize } from './memoize';\n\ntype Options = Omit<\n  NonNullable<Parameters<typeof memoize>[1]>,\n  'noWeakMap'\n>;\n\n/**\n * Create a memoized function with args\n *\n * @example\n * import { memoizeWithArgs } from 'proxy-memoize';\n *\n * const fn = memoizeWithArgs((a, b) => ({ sum: a.v + b.v, diff: a.v - b.v }));\n *\n * @param options\n * @param options.size - (default: 1)\n */\nexport const memoizeWithArgs = <Args extends unknown[], Result>(\n  fnWithArgs: (...args: Args) => Result,\n  options?: Options,\n) => {\n  const fn = memoize(\n    (args: Args) => fnWithArgs(...args),\n    { ...options, noWeakMap: true },\n  );\n  return (...args: Args) => fn(args);\n};\n"],"names":["HAS_KEY_PROPERTY","ALL_OWN_KEYS_PROPERTY","HAS_OWN_KEY_PROPERTY","KEYS_PROPERTY","isObject","x","untrack","seen","untrackedObj","getUntracked","trackMemo","has","add","Object","entries","forEach","k","v","vv","is","touchAffected","dst","src","affected","_used$HAS_KEY_PROPERT","_used$HAS_OWN_KEY_PRO","_used$KEYS_PROPERTY","used","get","key","Reflect","ownKeys","getOwnPropertyDescriptor","OBJ_PROPERTY","RESULT_PROPERTY","AFFECTED_PROPERTY","memoize","fn","options","_options$size","memoListHead","size","memoList","resultCache","noWeakMap","WeakMap","memoizedFn","obj","cache","i","memo","isChanged","set","proxy","createProxy","result","Set","entry","memoizeWithArgs","fnWithArgs","args","_extends"],"mappings":"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"}